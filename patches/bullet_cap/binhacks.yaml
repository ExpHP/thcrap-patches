codecaves:
  bullet-cap:
    /value-if(th08): "00006000"
    /value-if(not(th08)): "00007d00"
  laser-cap: "00001000"
  cancel-cap:
    /value-if(not(any(th08, th125, th128))): "00008000"
    /value-if(th08):  "00008300"
    /value-if(th125): "00000c80"
    /value-if(th128): "00000640"

  base-exphp.bullet-cap-status:
    /value-if(any(th10,th11,th12,th125,th128,th13)): "01000000"
    /value-if(any(th08)): "07000000"

  # Lag spike "softening" constant for big cancels in MoF and SA.
  # Bigger number = more lag.
  #
  # On my FX-8170 (3.8GHz), this default value makes 32000 cancels in SA
  # take about 4s, and larger cancels go linear with the number of bullets.
  bullet-cap-config.anm-search-lag-spike-size: "00002000"
  bullet-cap-config.mof-sa-lag-spike-size: "ffffffff" # deprecated name, takes over if non-negative

binhacks:
  ExpHP.bullet-cap.install:
    /fields-if(th08):
      addr: "0x43b414"
      expected: "e8875dffff"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B8A0114300        " # mov   eax, 0x4311a0
        - "FFD0              " # call  eax
        - "E800000000C70424 19b44300 C3" # jump to 0x43b419

    /fields-if(th10):
      addr: "0x420ec8"
      expected: "e883b20200"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B850C14400        " # mov   eax, 0x44c150
        - "FFD0              " # call  eax
        - "E800000000C70424 cd0e4200 C3" # jump to 0x420ecd

    /fields-if(th11):
      addr: "0x42a51e"
      expected: "be703a4c00"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "BE703A4C00        " # mov   esi, 0x4c3a70
        - "E800000000C70424 23a54200 C3" # jump to 0x42a523

    /fields-if(th12):
      addr: "0x43051e"
      expected: "bed8f04c00"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "BED8F04C00        " # mov   esi, 0x4cf0d8
        - "E800000000C70424 23054300 C3" # jump to 0x430523

    /fields-if(th125):
      addr: "0x41d9a3"
      expected: "e8f8c70000"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B8A0A14200        " # mov   eax, 0x42a1a0
        - "FFD0              " # call  eax
        - "E800000000C70424 a8d94100 C3" # jump to 0x41d9a8

    /fields-if(th128):
      addr: "0x426970"
      expected: "e83be30000"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B8B04C4300        " # mov   eax, 0x434cb0
        - "FFD0              " # call  eax
        - "E800000000C70424 75694200 C3" # jump to 0x426975

    /fields-if(th13):
      addr: "0x42c4f0"
      expected: "e88bed0000"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B880B24300        " # mov   eax, 0x43b280
        - "FFD0              " # call  eax
        - "E800000000C70424 f5c44200 C3" # jump to 0x42c4f5

  /fields-if(any(th10, th11, th12)):
    ExpHP.bullet-cap.fix-next-cancel:
      /fields-if(th10):
        addr: "0x41bdf9"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          - "E800000000C70424 0abe4100 C3" # jump to 0x41be0a

      /fields-if(th11):
        addr: "0x42454d"
        expected: "4181e1ff070080"
        codecave:
          - "51                " # push ecx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C1              " # mov  ecx, eax
          - "E800000000C70424 5e454200 C3" # jump to 0x42455e

      /fields-if(th12):
        addr: "0x427859"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          - "E800000000C70424 6a784200 C3" # jump to 0x42786a

  # UFO (and GFW) actually has a bug in some of its loops over items where it misses the
  # last 16 cancel items because he forgot to include UFOs in the iteration count.
  #
  # Fix these now so that they get picked up by our search and replace.
  /fields-if(any(th12, th128)):
    ExpHP.bullet-cap.fix-ufo-item-bugs:
      /fields-if(th12):
        addr:
          - "0x427243"  # ItemManager::on_draw
          - "0x427b5d"  # involves PLAYER, seems to be dead code though
        expected: "580a0000"
        code: "680a0000"

      /fields-if(th128):
        addr: "0x429223"  # ItemManager::on_draw
        expected: "bc020000"
        code: "cc020000"

  /fields-if(any(th10, th11, th13)):
    ExpHP.bullet-cap.cancel-perf-fix:
      /fields-if(th10):
        addr: "0x4491cd"
        expected: "8b82d4da7200"
      /fields-if(th11):
        addr: "0x4561ed"
        expected: "8b822c567b00"
      # 12, 125, and 128 are fine, but the problem returns in th13.
      /fields-if(th13):
        addr: "0x46fbae"
        expected: "8b820882f400"
      codecave:
        - "52                " # push edx  ; save
        - "51                " # push ecx  ; save
        - "51                " # push ecx  ; argument
        - "E8[codecave:ExpHP.bullet-cap.less-spikey-find-world-vm]" # call less_spikey_find_world_vm
        - "59                " # pop  ecx
        - "5A                " # pop  edx

        - "85C0              " # test eax, eax
        - "7404              " # jz   .continue

        # .success:
        - /item-if(not(th13)): "90" # nop
        - /item-if(th13):      "5D" # pop  ebp
        - "C20400            " # ret  0x4  ; exit early from this function

        # .continue:
        # go to part that checks UI list
        - "56                " # push esi  ; stack operation in code we're skipping over
        - /item-if(th10): "E800000000C70424 e5914400 C3" # jump to 0x4491e5
        - /item-if(th11): "E800000000C70424 05624500 C3" # jump to 0x456205
        - /item-if(th13): "E800000000C70424 d1fb4600 C3" # jump to 0x46fbd1
