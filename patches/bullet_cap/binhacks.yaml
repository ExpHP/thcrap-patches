binhacks:
  ExpHP.bullet-cap.install:
    /fields-if(th10):
      addr: "0x420ec8"
      expected: "e883b20200"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "B850C14400        " # mov   eax, 0x44c150
        - "FFD0              " # call  eax
        # abs_jmp_hack 0x420ecd
        - "E800000000        " # call %%next
        - "C70424CD0E4200    " # mov dword [esp], %1
        - "C3                " # ret

    /fields-if(th11):
      addr: "0x42a51e"
      expected: "be703a4c00"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "BE703A4C00        " # mov   esi, 0x4c3a70
        # abs_jmp_hack 0x42a523
        - "E800000000        " # call %%next
        - "C7042423A54200    " # mov dword [esp], %1
        - "C3                " # ret

    /fields-if(th12):
      addr: "0x43051e"
      expected: "bed8f04c00"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - "BED8F04C00        " # mov   esi, 0x4cf0d8
        # abs_jmp_hack 0x430523
        - "E800000000        " # call %%next
        - "C7042423054300    " # mov dword [esp], %1
        - "C3                " # ret

  /fields-if(any(th10, th11, th12)):
    ExpHP.bullet-cap.fix-next-cancel:
      /fields-if(th10):
        addr: "0x41bdf9"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          # abs_jmp_hack 0x41be0a
          - "E800000000        " # call %%next
          - "C704240ABE4100    " # mov dword [esp], %1
          - "C3                " # ret

      /fields-if(th11):
        addr: "0x42454d"
        expected: "4181e1ff070080"
        codecave:
          - "51                " # push ecx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C1              " # mov  ecx, eax
          # abs_jmp_hack 0x42455e
          - "E800000000        " # call %%next
          - "C704245E454200    " # mov dword [esp], %1
          - "C3                " # ret

      /fields-if(th12):
        addr: "0x427859"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          # abs_jmp_hack 0x42786a
          - "E800000000        " # call %%next
          - "C704246A784200    " # mov dword [esp], %1
          - "C3                " # ret

  # UFO actually has a bug in some of its loops over items where it misses the
  # last 16 cancel items because he forgot to include UFOs in the iteration count.
  #
  # Fix these now so that they get picked up by our search and replace.
  /fields-if(th12):
    ExpHP.bullet-cap.fix-ufo-item-bugs:
      addr:
        - "0x427243"  # ItemManager::on_draw
        - "0x427b5d"  # involves PLAYER, seems to be dead code though
      expected: "580a0000"
      code: "680a0000"
