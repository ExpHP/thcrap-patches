codecaves:
  bullet-cap:
    /value-if(th06): "00002800"
    /value-if(th07): "00004000"
    /value-if(th08): "00006000"
    /value-if(any(th10..th17)): "00007d00"
  laser-cap:
    /value-if(th06..th07): "00000400"
    /value-if(any(th08, th10..th143)): "00001000"
    /value-if(th15..th17): "00002000"
  cancel-cap:
    /value-if(th06):  "00002000"
    /value-if(th07):  "000044c0"
    /value-if(th08):  "00008300"
    /value-if(all(integer, th10..th13)): "00008000"
    /value-if(all(not(th165), th14..th17)): "00010000"
    /value-if(any(th125, th165)): "00000c80"
    /value-if(th128): "00000640"

  # Lag spike "softening" constant for big cancels in MoF and SA.
  # Bigger number = more lag.
  #
  # On my FX-8170 (3.8GHz), this default value makes 32000 cancels in SA
  # take about 4s, and larger cancels go linear with the number of bullets.
  bullet-cap-config.anm-search-lag-spike-size: "00002000"
  bullet-cap-config.mof-sa-lag-spike-size: "ffffffff" # deprecated name, takes over if non-negative

binhacks:
  # Uncomment this to give yourself a chance to attach CE if you need to debug a crash in life before main.
  # ExpHP.bullet-cap.loop:
  #   addr:
  #     - /item-if(th07): "0x47ea7d"
  #     - /item-if(th08): "0x4a619e"
  #   expected: "6a60"  # push 60
  #   code: "EBFE"

  ExpHP.bullet-cap.install:
    /fields-if(any(th07..th08)):
      addr:
        /value-if(th07): "0x42f0db"
        /value-if(th08): "0x43b414"
      expected:
        /value-if(th07): "e8c085ffff"
        /value-if(th08): "e8875dffff"
      codecave:
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize

        # original code
        - /item-if(th07): "B8A0764200        " # mov   eax, 0x4276a0
        - /item-if(th08): "B8A0114300        " # mov   eax, 0x4311a0
        - "FFD0              " # call  eax
        - /item-if(th07): "E800000000C70424E0F04200C3" # abs_jmp_hack 0x42f0e0
        - /item-if(th08): "E800000000C7042419B44300C3" # abs_jmp_hack 0x43b419

    /fields-if(any(th10..th17)):
      addr:
        /value-if(th10):  "0x420ec8"
        /value-if(th11):  "0x420328"
        /value-if(th12):  "0x422758"
        /value-if(th125): "0x41d9a3"
        /value-if(th128): "0x426970"
        /value-if(th13):  "0x42c4f0"
        /value-if(th14):  "0x4365c5"
        /value-if(th143): "0x432f6a"
        /value-if(th15):  "0x43cbef"
        /value-if(th16):  "0x42d76e"
        /value-if(th165): "0x429719"
        /value-if(th17):  "0x4312ff"
      expected:
        /value-if(th10):  "e883b20200"
        /value-if(th11):  "e8d3a10000"
        /value-if(th12):  "e8a3dd0000"
        /value-if(th125): "e8f8c70000"
        /value-if(th128): "e83be30000"
        /value-if(th13):  "e88bed0000"
        /value-if(th14):  "e836f50000"
        /value-if(th143): "e8611b0100"
        /value-if(th15):  "e8fc0b0100"
        /value-if(th16):  "e83dee0000"
        /value-if(th165): "e892000100"
        /value-if(th17):  "e87c0f0100"
      codecave:
        - "51                " # push ecx  ; save; might be an arg to the original function
        - "E8[codecave:ExpHP.bullet-cap.initialize]" # call initialize
        - "59                " # pop  ecx

        # original code
        - /item-if(th10):  "B850C14400FFD0    " # call_eax 0x44c150
        - /item-if(th11):  "B800A54200FFD0    " # call_eax 0x42a500
        - /item-if(th12):  "B800054300FFD0    " # call_eax 0x430500
        - /item-if(th125): "B8A0A14200FFD0    " # call_eax 0x42a1a0
        - /item-if(th128): "B8B04C4300FFD0    " # call_eax 0x434cb0
        - /item-if(th13):  "B880B24300FFD0    " # call_eax 0x43b280
        - /item-if(th14):  "B8005B4400FFD0    " # call_eax 0x43b280
        - /item-if(th143): "B8D04A4400FFD0    " # call_eax 0x444ad0
        - /item-if(th15):  "B8F0D74400FFD0    " # call_eax 0x44d7f0
        - /item-if(th16):  "B8B0C54300FFD0    " # call_eax 0x43c5b0
        - /item-if(th165): "B8B0974300FFD0    " # call_eax 0x4397b0
        - /item-if(th17):  "B880224400FFD0    " # call_eax 0x442280
        # (can't use call-codecave and ret because it'd mess with stack args to the above call)
        - /item-if(th10):  "E800000000C70424CD0E4200C3" # abs_jmp_hack 0x420ecd
        - /item-if(th11):  "E800000000C704242D034200C3" # abs_jmp_hack 0x42032d
        - /item-if(th12):  "E800000000C704245D274200C3" # abs_jmp_hack 0x42275d
        - /item-if(th125): "E800000000C70424A8D94100C3" # abs_jmp_hack 0x41d9a8
        - /item-if(th128): "E800000000C7042475694200C3" # abs_jmp_hack 0x426975
        - /item-if(th13):  "E800000000C70424F5C44200C3" # abs_jmp_hack 0x42c4f5
        - /item-if(th14):  "E800000000C70424CA654300C3" # abs_jmp_hack 0x4365ca
        - /item-if(th143): "E800000000C704246F2F4300C3" # abs_jmp_hack 0x432f6f
        - /item-if(th15):  "E800000000C70424F4CB4300C3" # abs_jmp_hack 0x43cbf4
        - /item-if(th16):  "E800000000C7042473D74200C3" # abs_jmp_hack 0x42d773
        - /item-if(th165): "E800000000C704241E974200C3" # abs_jmp_hack 0x42971e
        - /item-if(th17):  "E800000000C7042404134300C3" # abs_jmp_hack 0x431304

  /fields-if(any(th10, th11, th12)):
    ExpHP.bullet-cap.fix-next-cancel:
      /fields-if(th10):
        addr: "0x41bdf9"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          - "E800000000C70424 0abe4100 C3" # jump to 0x41be0a

      /fields-if(th11):
        addr: "0x42454d"
        expected: "4181e1ff070080"
        codecave:
          - "51                " # push ecx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C1              " # mov  ecx, eax
          - "E800000000C70424 5e454200 C3" # jump to 0x42455e

      /fields-if(th12):
        addr: "0x427859"
        expected: "4281e2ff070080"
        codecave:
          - "52                " # push edx
          - "E8[codecave:ExpHP.bullet-cap.next-cancel-index]" # call next_cancel_index
          - "89C2              " # mov  edx, eax
          - "E800000000C70424 6a784200 C3" # jump to 0x42786a

  # UFO (and GFW) actually has a bug in some of its loops over items where it misses the
  # last 16 cancel items because he forgot to include UFOs in the iteration count.
  #
  # Fix these now so that they get picked up by our search and replace.
  /fields-if(any(th12, th128)):
    ExpHP.bullet-cap.fix-ufo-item-bugs:
      /fields-if(th12):
        addr:
          - "0x427243"  # ItemManager::on_draw
          - "0x427b5d"  # involves PLAYER, seems to be dead code though
        expected: "580a0000"
        code: "680a0000"

      /fields-if(th128):
        addr: "0x429223"  # ItemManager::on_draw
        expected: "bc020000"
        code: "cc020000"

  /fields-if(any(th10, th11, th13)):
    ExpHP.bullet-cap.cancel-perf-fix:
      /fields-if(th10):
        addr: "0x4491cd"
        expected: "8b82d4da7200"
      /fields-if(th11):
        addr: "0x4561ed"
        expected: "8b822c567b00"
      # 12, 125, and 128 are fine, but the problem returns in th13.
      /fields-if(th13):
        addr: "0x46fbae"
        expected: "8b820882f400"
      codecave:
        - "52                " # push edx  ; save
        - "51                " # push ecx  ; save
        - "51                " # push ecx  ; argument
        - "E8[codecave:ExpHP.bullet-cap.less-spikey-find-world-vm]" # call less_spikey_find_world_vm
        - "59                " # pop  ecx
        - "5A                " # pop  edx

        - "85C0              " # test eax, eax
        - "7404              " # jz   .continue

        # .success:
        - /item-if(not(th13)): "90" # nop
        - /item-if(th13):      "5D" # pop  ebp
        - "C20400            " # ret  0x4  ; exit early from this function

        # .continue:
        # go to part that checks UI list
        - "56                " # push esi  ; stack operation in code we're skipping over
        - /item-if(th10): "E800000000C70424 e5914400 C3" # jump to 0x4491e5
        - /item-if(th11): "E800000000C70424 05624500 C3" # jump to 0x456205
        - /item-if(th13): "E800000000C70424 d1fb4600 C3" # jump to 0x46fbd1
